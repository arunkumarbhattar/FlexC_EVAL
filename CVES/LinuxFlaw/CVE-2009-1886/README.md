# CVE-2009-1886

## 实验环境
OS: Ubuntu 14.04 LTS

## 安装 Samba

    sudo apt-get install samba samba-client # service will automate start

    Comments: 为什么我们直接使用系统中的samba呢，因为本身这个漏洞的主体smbclient 只是samba里面一个组件而已,没有必要自己去配置samba服务。而我们为什么安装samba-client是因为我们需要系统中的smbclient来测试我们的配置。

## 配置 Samba

### 配置共享文件夹

将下列内容添加到 /etc/samba/smb.conf 中

    [vmware]
        comment = vmware
        path = /home/mudongliang/vmware/ # path should exist
        browseable = yes
        writable = yes # writable must be yes 

### 添加用户
 
    smbpasswd -a mudongliang #your own user name and set password

### 连接测试
  
    # connect to the samba server:
    smbclient //127.0.0.1/vmware/ -U mudongliang

### 源码编译

    tar -zxvf samba-3.2.12.tar.gz
    cd samba-3.2.12
    cd source/
    ./autogen.sh

    ./configure
    make
    sudo make install

### 问题解决

**Problem1**: 缺少动态链接库

    $ cd /usr/local/samba/bin

    $ ./smbclient //127.0.0.1/vmware -U mudongliang
        ./smbclient: error while loading shared libraries: libtalloc.so.1: cannot open shared object file: No such file or directory

    $ ldd smbclient 
        linux-vdso.so.1 =>  (0x00007ffd7813b000)
        libresolv.so.2 => /lib/x86_64-linux-gnu/libresolv.so.2 (0x00007fc053cba000)
        libnsl.so.1 => /lib/x86_64-linux-gnu/libnsl.so.1 (0x00007fc053aa0000)
        libdl.so.2 => /lib/x86_64-linux-gnu/libdl.so.2 (0x00007fc05389c000)
        libtalloc.so.1 => not found
        libtdb.so.1 => /usr/lib/x86_64-linux-gnu/libtdb.so.1 (0x00007fc05368a000)
        libwbclient.so.0 => /usr/lib/x86_64-linux-gnu/libwbclient.so.0 (0x00007fc05347e000)
        libc.so.6 => /lib/x86_64-linux-gnu/libc.so.6 (0x00007fc0530b9000)
        /lib64/ld-linux-x86-64.so.2 (0x00007fc054472000)
        libwinbind-client.so.0 => /usr/lib/x86_64-linux-gnu/samba/libwinbind-client.so.0 (0x00007fc052eb6000)
        libbsd.so.0 => /lib/x86_64-linux-gnu/libbsd.so.0 (0x00007fc052ca7000)
        libpthread.so.0 => /lib/x86_64-linux-gnu/libpthread.so.0 (0x00007fc052a89000)

**Solution**:

    $ cd ../lib
    $ sudo ln /usr/local/samba/lib/libtalloc.so.1 /lib/x86_64-linux-gnu/libtalloc.so.1

    $ ldd smbclient 
        linux-vdso.so.1 =>  (0x00007ffd7813b000)
        libresolv.so.2 => /lib/x86_64-linux-gnu/libresolv.so.2 (0x00007fc053cba000)
        libnsl.so.1 => /lib/x86_64-linux-gnu/libnsl.so.1 (0x00007fc053aa0000)
        libdl.so.2 => /lib/x86_64-linux-gnu/libdl.so.2 (0x00007fc05389c000)
	    libtalloc.so.1 => /lib/x86_64-linux-gnu/libtalloc.so.1 (0x00007f30f1e15000)
        libtdb.so.1 => /usr/lib/x86_64-linux-gnu/libtdb.so.1 (0x00007fc05368a000)
        libwbclient.so.0 => /usr/lib/x86_64-linux-gnu/libwbclient.so.0 (0x00007fc05347e000)
        libc.so.6 => /lib/x86_64-linux-gnu/libc.so.6 (0x00007fc0530b9000)
        /lib64/ld-linux-x86-64.so.2 (0x00007fc054472000)
        libwinbind-client.so.0 => /usr/lib/x86_64-linux-gnu/samba/libwinbind-client.so.0 (0x00007fc052eb6000)
        libbsd.so.0 => /lib/x86_64-linux-gnu/libbsd.so.0 (0x00007fc052ca7000)
        libpthread.so.0 => /lib/x86_64-linux-gnu/libpthread.so.0 (0x00007fc052a89000)

**Problem2**: 缺少配置文件

    $ ./smbclient //127.0.0.1/vmware -U mudongliang
    params.c:OpenConfFile() - Unable to open configuration file "/usr/local/samba/lib/smb.conf":
        No such file or directory
    ./smbclient: Can't load /usr/local/samba/lib/smb.conf - run testparm to debug it

**Solution**:

    $ sudo cp /etc/samba/smb.conf /usr/local/samba/lib/

### 漏洞测试

    $ /usr/local/samba/bin/smbclient //127.0.0.1/vmware -U mudongliang

    # According to the logic of smbclient, file to be put must exist.
    $ smb: \> !touch aa%3Fbb

    $ smb: \> put aa%3Fbb
    putting file aa%3Fbb as \aa0.000000bb (0.0 kb/s) (average 0.0 kb/s)
