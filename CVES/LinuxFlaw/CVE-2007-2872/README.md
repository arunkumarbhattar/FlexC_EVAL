# CVE-2007-2872

## Experiment Environment

CentOs 6.5

## INSTALL & Configuration

```
https://github.com/mudongliang/source-packages/raw/master/CVE-2006-4812/php-5.1.6.tar.gz
tar -xvf php-5.1.6.tar.gz
cd php-5.1.6
./configure
make
```

## Problems in Installation & Configuration


## How to trigger vulnerability

```
./sapi/cli/php poc.php
```

## PoCs

[PHP Chunk_Split() Function Integer Overflow Vulnerability](https://www.securityfocus.com/bid/24261/exploit)

[PHP 5.1.6 - 'Chunk_Split()' Integer Overflow](https://www.exploit-db.com/exploits/30117/)

## Vulnerability Patch

### Root Cause

In line 1963 the chunk_split function tries to allocate the adequate
size of memory for the result of the function. In case the values chunks
and endlen are bigger than 65534 an integer overflow is triggered and
the wrong size of memory is allocated, which results in a heap overflow.

ext/standard/string.c:

```
1953 static char *php_chunk_split(char *src, int srclen, char *end,
int endlen, int chunklen, int *destlen)
1954 {
1955     char *dest;
1956     char *p, *q;
1957     int chunks; /* complete chunks! */
1958     int restlen;
1959
1960     chunks = srclen / chunklen;
1961     restlen = srclen - chunks * chunklen; /* srclen % chunklen */
1962
1963     dest = safe_emalloc((srclen + (chunks + 1) * endlen + 1), sizeof(char), 0);
1964
1965     for (p = src, q = dest; p < (src + srclen - chunklen + 1); ) {
1966         memcpy(q, p, chunklen);
1967         q += chunklen;
1968         memcpy(q, end, endlen);
1969         q += endlen;
1970         p += chunklen;
1971    }
```

### Stack Trace

### Patch

## References
