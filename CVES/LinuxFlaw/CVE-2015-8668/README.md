# CVE-2015-8668

## Experiment Environment

Ubuntu 14.04LTS

## INSTALL & Configuration

```
wget https://github.com/mudongliang/source-packages/raw/master/CVE-2015-8668/tiff-4.0.1.tar.gz
tar -xvf tiff-4.0.1.tar.gz
cd tiff-4.0.1
./configure
make
```

## Problems in Installation & Configuration


## How to trigger vulnerability

```
./tools/bmp2tiff ./libtiff-poc.bmp out.tif
```

## PoCs

[CVE-2015-8668: libtiff bmp file Heap Overflow](http://bugzilla.maptools.org/show_bug.cgi?id=2563)

[LibTIFF CVE-2015-8668 Heap Buffer Overflow Vulnerability](https://www.securityfocus.com/bid/79696/exploit)

## Vulnerability Details & Patch

### Root Cause

libtiff  v4.0.6 bmp2tiff function PackBitsPreEncode()
(./libtiff/tif_packbits.c ) handle malicious bmp file (Width = 
65663) to cause memory corruption. An attacker could exploit this issue to
execute arbitrary code in the context of the 
application using the library.

### Stack Trace

### Patch

```
diff --git a/tools/bmp2tiff.c b/tools/bmp2tiff.c
index 376f4e6..c747c13 100644
--- a/tools/bmp2tiff.c
+++ b/tools/bmp2tiff.c
@@ -614,19 +614,27 @@ main(int argc, char* argv[])
 			    || info_hdr.iCompression == BMPC_RLE4 ) {
 			uint32		i, j, k, runlength;
 			uint32		compr_size, uncompr_size;
+			uint32      bits = 0;
 			unsigned char   *comprbuf;
 			unsigned char   *uncomprbuf;
 
 			compr_size = file_hdr.iSize - file_hdr.iOffBits;
-			uncompr_size = width * length;
-            /* Detect int overflow */
-            if( uncompr_size / width != length )
-            {
-                TIFFError(infilename,
-                    "Invalid dimensions of BMP file" );
-                close(fd);
-                return -1;
-            }
+
+			bits = info_hdr.iBitCount;
+
+			if (bits > 8) // bit depth is > 8bit, adjust size
+			{
+				uncompr_size = width * length * (bits / 8);
+				/* Detect int overflow */
+				if (uncompr_size / width / (bits / 8) != length) {
+					TIFFError(infilename,
+							   "Invalid dimensions of BMP file");
+					close(fd);
+					return -1;
+				}
+			}
+			else
+				uncompr_size = width * length;
 			comprbuf = (unsigned char *) _TIFFmalloc( compr_size );
 			if (!comprbuf) {
 				TIFFError(infilename,
```

## References
