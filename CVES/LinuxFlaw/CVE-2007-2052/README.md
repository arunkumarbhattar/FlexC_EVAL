# CVE-2007-2052

## Experiment Environment

Ubuntu 10.04LTS

## INSTALL & Configuration

```
wget https://github.com/mudongliang/source-packages/raw/master/CVE-2007-2052/Python-2.5.tgz
tar -xvf Python-2.5.tgz
cd Python-2.5
./confiure
make
```

## Problems in Installation & Configuration


## How to trigger vulnerability

```
$ ./python poc.py
en_US.UTF8
'\x0c\x01\x08\x01\x02\x01\x18\x08\x10'

Here, '\x0c\x01\x08\x01\x02\x01' comes from glibc's strxfrm(), and the
rest of the string is the contents of the memory immediately after the
destination buffer. (It is also possible to get identifiable parts of
the strings processed by the program before the strxfrm() call but I
don't have a reproducible test case for that.)
```

## PoCs

[python2.5: off-by-one bug in strxfrm() (causes information leak)](https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=416934)

[Python PyLocale_strxfrm Function Remote Information Leak Vulnerability](https://www.securityfocus.com/bid/23887/exploit)

[Python 2.5 - 'PyLocale_strxfrm' Remote Information Leak](https://www.exploit-db.com/exploits/30018/)

**Note:** change `pl_PL.UTF8` to one common locale - `en_US.UTF8`

## Vulnerability Details & Patch

### Root Cause

Modules/_localemodule.c:361

```
356         n1 = strlen(s) + 1;
357         buf = PyMem_Malloc(n1);
358         if (!buf)
359             return PyErr_NoMemory();
360         n2 = strxfrm(buf, s, n1);
```

In case the transformed string is longer than original string...
(see the PoC for an exapmle)

361         if (n2 > n1) {
362             /* more space needed */

We allocate n2 bytes here:

```
363             buf = PyMem_Realloc(buf, n2);
364             if (!buf)
365                 return PyErr_NoMemory();
```

And here the string will be n2 chars long and terminating NUL won't
fit and thus the string won't be terminated what can lead to an
information leak in certain rare cases (see the original Debian report
for details).

```
366             strxfrm(buf, s, n2);
367         }
368         result = PyString_FromString(buf);
369         PyMem_Free(buf);
370         return result;
371     }
```

### Stack Trace

### Patch

## References
