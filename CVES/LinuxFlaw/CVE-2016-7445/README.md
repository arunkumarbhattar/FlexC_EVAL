# CVE-2016-7445

## Experiment Environment
Ubuntu 14.04 LTS

## INSTALL & Configuration
```
wget https://github.com/uclouvain/openjpeg/archive/v2.1.1.tar.gz
tar xvf v2.1.1.tar.gz
cd openjpeg-2.1.1
mkdir build
cd build
cmake ..
make
```

## Problems in Installation & Configuration
"could not find TIFF"
```
sudo apt-get install libtiff5-dev
```

"could not find LCMS2"
```
sudo apt-get install liblcms2-dev
```

"convertpng.c: undefined reference to `png\_jmpbuf'"  
"..."  
"convertpng.c: undefined reference to `png\_get\_bit\_depth'"
```
wget ftp://ftp-osl.osuosl.org/pub/libpng/src/libpng16/libpng-1.6.32.tar.gz
tar xvf libpng-1.6.32.tar.gz
cd lipng-1.6.32.tar.gz
./configure
make
sudo make install
```
If you try to install libpng directly through apt-get, the \*.so and \*.a file will not be installed in /usr/local/lib.


## How to trigger vulnerability
```
./bin/opj_compress -i openjpeg-nullptr-github-issue-842.ppm -o out.j2k
```

## PoCs
[openjpeg-issue-843](https://github.com/uclouvain/openjpeg/issues/843)

## Vulnerability Details & Patch

### Root Cause
src/binjp2/convert.c
```
read_pnm_header() {
	...
1483 	s = skip_int(s, &ph->width);
	...
1485 	s = skip_int(s, &ph->height);
	... // no check about if NULL == s
1493	s = skip_int (s, &ph->maxval); 
	...
}

skip_int(char *start) {
	... // no check about if NULL == start
1347	s = skip_white(start); 
}

skip_white(char *s) {
1331 while(*s) // using ptr s without excluding "NULL == s"
}
```

### Stack Trace
```
#0  0x0805259f in skip_white (s=0x0) at openjpeg/openjpeg-2.1.1/src/bin/jp2/convert.c:1331
#1  0x080525c7 in skip_int (start=0x0, out_n=0xbfff995c) at openjpeg/openjpeg-2.1.1/src/bin/jp2/convert.c:1347
#2  0x08052c4b in read_pnm_header (reader=0x806f008, ph=0xbfff9954) at openjpeg/openjpeg-2.1.1/src/bin/jp2/convert.c:1493
#3  0x08053047 in pnmtoimage (filename=0xbfffc1b8 "../../../trigger/openjpeg-nullptr-github-issue-842.ppm", parameters=0xbfffaab8)
    at openjpeg/openjpeg-2.1.1/src/bin/jp2/convert.c:1582
#4  0x0804e435 in main (argc=0x5, argv=0xbffff474) at openjpeg/openjpeg-2.1.1/src/bin/jp2/opj_compress.c:1722
#5  0xb7c9baf3 in __libc_start_main (main=0x804e090 <main>, argc=0x5, argv=0xbffff474, init=0x80675b0 <__libc_csu_init>, fini=0x8067620 <__libc_csu_fini>, 
    rtld_fini=0xb7fed2d0 <_dl_fini>, stack_end=0xbffff46c) at libc-start.c:287
#6  0x0804a471 in _start ()
```
## References
