# CVE-2017-11403

## Experiment Environment
Ubuntu 14.04 LTS

## INSTALL & Configuration
```
wget https://qa.debian.org/watch/sf.php/graphicsmagick/GraphicsMagick-1.3.26.tar.gz
tar xvf GraphicsMagick-1.3.26.tar.gz
cd GraphicsMagick-1.3.26
CFLAGS="-g -O0 -fsanitize=address" ./configure
make 
```

## Problems in Installation & Configuration

## How to trigger vulnerability
```
utilities/gm identify poc
```

## PoCs
[agostino's blog](https://github.com/asarubbo/poc/blob/master/00333-graphicsmagick-UAF-CloseBlob)

## Vulnerability Details & Patch

### Root Cause
```
coders/png.c
ReadMNGImage() {
5129:	previous = image; // heap object to be double-freed
5130:	mng_info->image = image;
5138:	ReadOneJNGImage(mng_info); // first free here
5143:	DestroyImageList(previous); // second free here
}

coders/png.c
ReadOneJNGImage(MngInfo *mng_info) {
			Image *image = mng_info->image;
3126:	ThrowReaderException(image); // a macro in which image will be freed
}

magick/error.h
#define ThrowReaderException(image_) \
do{
	DestroyImageList(image_);
} while(0);

magick/list.c
DestroyImageList(Image* images) {
231:	assert(images->signatures == MagickSignature);
239:	DestroyImage(images); // free function
}
```

### Stack Trace
```
#0  DestroyImageList (images=0xb3d05500) at magick/list.c:229
#1  0x0830b51a in ReadMNGImage (image_info=0xb3f04900, exception=0xbfffeaf0) at coders/png.c:5143
#2  0x080c6097 in ReadImage (image_info=0xb3f02500, exception=0xbfffeaf0)
    at magick/constitute.c:1607
#3  0x080c4eea in PingImage (image_info=0xb3f00100, exception=0xbfffeaf0)
    at magick/constitute.c:1370
#4  0x0807a161 in IdentifyImageCommand (image_info=0xb3f00100, argc=2, argv=0xb5f01300,
    metadata=0xbfffeab0, exception=0xbfffeaf0) at magick/command.c:8379
#5  0x0807c3dd in MagickCommand (image_info=0xb3f00100, argc=2, argv=0xbffff478,
    metadata=0xbfffeab0, exception=0xbfffeaf0) at magick/command.c:8869
#6  0x080a99b8 in GMCommandSingle (argc=2, argv=0xbffff478) at magick/command.c:17396
#7  0x080a9ba0 in GMCommand (argc=3, argv=0xbffff474) at magick/command.c:17449
#8  0x08050218 in main (argc=3, argv=0xbffff474) at utilities/gm.c:61
```

## References
[agostino's blog](https://blogs.gentoo.org/ago/2017/09/01/graphicsmagick-use-after-free-in-closeblob-blob-c-incomplete-fix-for-cve-2017-11403/)
