# CVE-2015-8617

## Experiment Environment

Ubuntu 14.04LTS

## INSTALL & Configuration

```
wget https://github.com/mudongliang/source-packages/raw/master/CVE-2015-8617/php-7.0.0.tar.bz2
tar -xvf php-7.0.0.tar.bz2
cd php-7.0.0
./configure
make
```

## Problems in Installation & Configuration


## How to trigger vulnerability

```
./sapi/cli/php poc1.php
./sapi/cli/php poc2.php
```

## PoCs

[Format String Vulnerability in Class Name Error Message](https://bugs.php.net/bug.php?id=71105)

[PHP 7.0.0 - Format String](https://www.exploit-db.com/exploits/39082/)

## Vulnerability Details & Patch

### Root Cause

```
    if (fetch_type & ZEND_FETCH_CLASS_EXCEPTION) {
        zend_throw_error(exception_ce, message);
    } else {
        zend_error(E_ERROR, "%s", message);
    }
```


### Stack Trace

### Patch

```
diff -rup php-7.0.0_old/Zend/zend_execute_API.c 
php-7.0.0_new/Zend/zend_execute_API.c
--- php-7.0.0_old/Zend/zend_execute_API.c   2015-12-01 07:36:25.000000000 
-0600
+++ php-7.0.0_new/Zend/zend_execute_API.c   2015-12-12 12:24:24.999391117 
-0600
@@ -218,7 +218,7 @@ static void zend_throw_or_error(int fetc
    zend_vspprintf(&message, 0, format, va);
 
    if (fetch_type & ZEND_FETCH_CLASS_EXCEPTION) {
-       zend_throw_error(exception_ce, message);
+       zend_throw_error(exception_ce, "%s", message);
    } else {
        zend_error(E_ERROR, "%s", message);
    }
```

## References

<https://bugzilla.redhat.com/show_bug.cgi?id=CVE-2015-8617>
