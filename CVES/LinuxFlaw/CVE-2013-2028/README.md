# CVE-2013-2028

## Experiment Environment

Ubuntu 14.04 LTS

## INSTALL & Configuration

```
wget https://github.com/mudongliang/source-packages/raw/master/CVE-2013-2028/nginx-1.4.0.tar.gz

tar -xvf nginx-1.4.0.tar.gz
cd nginx-1.4.0

./configure
make
sudo make install
```

### Problems in Installation & Configuration

**1. miss pcre library**

>./configure: error: the HTTP rewrite module requires the PCRElibrary. You can either disable the module by using --without-http_rewrite_module option, or install the PCRE library into the system, or build the PCRE library statically from the source with nginx by using --with-pcre=<path> option. 

**Solution:**

    # sudo apt-get install libpcre3 libpcre3-dev


**2. miss zlib library**

>./configure: error: the HTTP gzip module requires the zlib library. You can either disable the module by using --without-http_gzip_module option, or install the zlib library into the  system, or build the zlib library statically from the source with nginx by using --with-zlib=<path> option.

**Solution:**

    # sudo apt-get install libssl-dev

or

    # sudo apt-get install zlib1g-dev

After you have compiled and installed nginx successfully, you can find all the files related to nginx are in `/usr/local/nginx` directory. The main configuration file is in the subdirectory - `conf`. The executable file is in the subdirectory - `sbin`.

### Start Nginx

    sudo /usr/local/nginx/sbin/nginx

Visit `http://localhost` to test whether you have installed nginx successfully.

## How to trigger vulnerability

```
sudo /usr/local/nginx/sbin/nginx

perl ngxunlock_pl.bin localhost 80 localhost 443
```

## PoCs

[Nginx 1.3.9/1.4.0 (x86) - Brute Force Remote Exploit](https://www.exploit-db.com/exploits/26737/)

[Nginx 1.3.9 < 1.4.0 - Chuncked Encoding Stack Buffer Overflow (Metasploit)](https://www.exploit-db.com/exploits/25775/)

[Nginx 1.4.0 (Generic Linux x64) - Remote Exploit](https://www.exploit-db.com/exploits/32277/)

[nginx 1.3.9-1.4.0 - DoS PoC](https://www.exploit-db.com/exploits/25499/)

[exp-nginx.rb](https://github.com/danghvu/nginx-1.4.0/blob/master/exp-nginx.rb)

## Vulnerability Details & Patch

### Root Cause

Stack Overflow:

```
ngx_http_request_body.c:652

	n = r->connection->recv(r->connection, buffer, size);	
```

Integer Overflow:

```
ngx_http_request_body.c:649

	size = (size_t) ngx_min(r->headers_in.content_length_n,
                                NGX_HTTP_DISCARD_BUFFER_SIZE);

```

### Stack Trace

```
(gdb) info stack
#0  0x0808b7e8 in ngx_http_discard_request_body_filter (r=0x41414141, b=0xbf9c1fe0)
    at src/http/ngx_http_request_body.c:686
#1  0x0808b7c8 in ngx_http_read_discarded_request_body (r=0x41414141) at src/http/ngx_http_request_body.c:670
#2  0x41414141 in ?? ()
#3  0x41414141 in ?? ()
#4  0x41414141 in ?? ()
```

### Patch

Please refer to References [3] - Nginx Patch

```
--- src/http/ngx_http_parse.c
+++ src/http/ngx_http_parse.c
@@ -2209,6 +2209,10 @@ data:
 
     }
 
+    if (ctx->size < 0 || ctx->length < 0) {
+        goto invalid;
+    }
+
     return rc;
 
 done:
```

## References

[1] [Nginx Download](http://nginx.org/download/nginx-1.3.9.tar.gz)

[2] [Nginx Mailing List](http://mailman.nginx.org/pipermail/nginx-announce/2013/000112.html)

[3] [Nginx Patch](http://nginx.org/download/patch.2013.chunked.txt)
