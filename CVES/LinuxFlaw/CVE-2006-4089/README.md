# CVE-2006-4089

## Experiment Environment

Ubuntu 10.04 LTS

## INSTALL & Configuration

```
wget https://github.com/mudongliang/source-packages/raw/master/CVE-2006-4089/alsaplayer_0.99.76.orig.tar.gz
tar -xvf alsaplayer_0.99.76.orig.tar.gz
cd alsaplayer-0.99.76
./configure
make
```

## Problems in Installation & Configuration


## How to trigger vulnerability

### Method 1

Client:

```
sudo nc -l -v -n 127.0.0.1 80 < alsapbof_a.txt
```

Server:

```
./app/alsaplayer http://127.0.0.1:80
```

### Method 2

```
./app/alsaplayer http://`perl -e 'print "a"x2000'`
```

### Method 3

Client:

```
sudo nc -l -v -n 127.0.0.1 888 < alsapbof_c.txt
```

Server:

```
./app/alsaplayer http://127.0.0.1:888
```

## PoCs

[AlsaPlayer 0.99.x - Multiple Buffer Overflow Vulnerabilities](https://www.exploit-db.com/exploits/28367/)

[AlsaPlayer Multiple Buffer Overflow Vulnerabilities](https://www.securityfocus.com/bid/19450/exploit)

[PoC](http://aluigi.org/poc/alsapbof.zip)

## Vulnerability Details & Patch

### Root Cause

A] buffer-overflow in reconnect's redirection

The function which handles the HTTP connections is vulnerable to a
buffer-overflow that happens when it uses sscanf for copying the URL in
the Location's field received from the server into the redirect buffer
of only 1024 bytes declared in http_open.

>From reader/http/http.c:

```
static int reconnect (http_desc_t *desc, char *redirect)
{
    char request [2048];
    char response [10240];
    ...
    } else if (rc == 302) {
            s = strstr(response, "302");
        if (s) {
            //alsaplayer_error("%s", s);
            s = strstr(response, "Location: ");
            if (s && redirect) {
                /* Parse redirect */
                if (sscanf(s, "Location: %[^\r]", redirect)) {
                    /* alsaplayer_error("Redirection: %s", redirect); */
                }           
            }
            return 1;
        }
    ...
```

B] buffer-overflow in GTK playlist

A buffer-overflow exists in the functions which add items to the
playlist when the GTK interface is used (so the other interfaces are
not affected by this problem): new_list_item and CbUpdated in
interface/gtk/PlaylistWindow.cpp.
The best way for exploiting this bug is through the following URLs
(perfect, for example, if AlsaPlayer is the default player of the web
browser):

  http://aaaaa(more_than_1024_chars)aaaaa
or
  http://127.0.0.1/aaaaa(more_than_1024_chars)aaaaa.mp3


C] buffer-overflow in cddb_lookup

AlsaPlayer automatically queries the CDDB server specified in its
configuration (by default freedb.freedb.org) when the user choices the
CDDA function for playing audio CDs.
The function which queries the server uses a buffer of 20 bytes and one
of 9 for storing the category and ID strings received from the server
while the buffer which contains this server's response is 32768 bytes
long.
Naturally for exploiting this bug the attacker must have control of the
freedb server specified in the AlsaPlayer's configuration.

>From input/ccda/cdda_engine.c:

```
char * cddb_lookup (char *address, char *char_port, int discID, struct cd_trk_list *tl)
{
    int port = atoi (char_port);
    int server_fd, i, j, n;
    int total_secs = 0, counter = 0;
    char *answer = NULL, *username, *filename, categ[20], newID[9];
    char msg[BUFFER_SIZE], offsets[BUFFER_SIZE], tmpbuf[BUFFER_SIZE];
    char hostname[MAXHOSTNAMELEN], server[80];
    ...
        /* copy the match to the category */
        j = 0;
        while (answer[i] != ' ') 
            categ[j++] = answer[i++];
        categ[j++] = '\0';

        /* copy the new cdID */
        j = 0; 
        i++;
        while (answer[i] != ' ') 
            newID[j++] = answer[i++];
        newID[j++] = '\0';
    }
    ...
```

### Stack Trace

### Patch

## References

[media-sound/alsaplayer Multiple Buffer Overflows (CVE-2006-4089)](https://bugs.gentoo.org/143402)
