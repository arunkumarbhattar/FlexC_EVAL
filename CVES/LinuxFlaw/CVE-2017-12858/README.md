# CVE-2017-12858

## Experiment Environment
Ubuntu 14.04 LTS

## INSTALL & Configuration
```
wget https://fossies.org/linux/misc/legacy/libzip-1.2.0.tar.gz
tar xvf libzip-1.2.0.tar.gz
CFLAGS="-g -O0 -fsanitize=address" ./configure
make
```

## Problems in Installation & Configuration

## How to trigger vulnerability
```
./ziptool ./poc.zip cat ./index
```

## PoCs
[agostino's blog](https://github.com/asarubbo/poc/blob/master/00239-libzip-UAF-_zip_buffer_free)

## Vulnerability Details & Patch

### Root Cause
```
zip_dirent.c
_zip_dirent_read() {
571:	_zip_buffer_free(buffer); // buffer is freed firstly here

582: 	_zip_buffer_free(buffer); // buffer could be secondly freed here
}
```

### Stack Trace
```
#0  _zip_buffer_free (buffer=0xb5600b20) at zip_buffer.c:53
#1  0xb69acf32 in _zip_dirent_read (zde=0xb5e01f20, src=0xb6201760, buffer=0xb5600b20, local=false,
    error=0xbfffeef0) at zip_dirent.c:582
#2  0xb69bd3bd in _zip_read_cdir (za=0xb5e01fa0, buffer=0xb5600be0, buf_offset=65574,
    error=0xbfffeef0) at zip_open.c:380
#3  0xb69beb7f in _zip_find_central_dir (za=0xb5e01fa0, len=131152) at zip_open.c:613
#4  0xb69bc339 in _zip_open (src=0xb6201760, flags=1, error=0xbffff0f0) at zip_open.c:200
#5  0xb69bc111 in zip_open_from_source (src=0xb6201760, _flags=1, error=0xbffff0f0)
    at zip_open.c:148
#6  0xb69bbdc8 in zip_open (fn=0xbffff60c "../../../trigger/00239-libzip-UAF-_zip_buffer_free",
    _flags=1, zep=0xbffff1a0) at zip_open.c:74
#7  0x08050bde in read_from_file (
    archive=0xbffff60c "../../../trigger/00239-libzip-UAF-_zip_buffer_free", flags=1,
    error=0xbffff2d0, offset=0, length=0) at ziptool.c:698
#8  0x080521fd in main (argc=4, argv=0xbffff484) at ziptool.c:1113
```

## References
[agostino's blog](https://blogs.gentoo.org/ago/2017/09/01/libzip-use-after-free-in-_zip_buffer_free-zip_buffer-c/)
