# CVE-2008-5904

## Experiment Environment
Ubuntu 14.04

## INSTALL & Configuration
```
wget https://downloads.sourceforge.net/project/xrdp/xrdp/0.4.1/xrdp-0.4.1.tar.gz
tar xvf xrdp-0.4.1.tar.gz
cd xrdp-0.4.1
make
sudo make install
```
## Problems in Installation & Configuration
```
verify_user_pam.c:32:31: fatal error: security/pam_appl.h: No such file or directory
	#include<security/pam_appl.h>
```
Solution: sudo apt-get install libpam0g-dev

```
Entering directory `...../sesman/libscp'
/usr/bin/ld: os_calls.o: undefined reference to smbol 'dlopen@@GLIBC_2.1'
```
Solution: add $(LDFLAGS) to the end of make cmd. Other similar problems use a similar solution

```
In function 'open',
	inlined from 'g_file_open' at ../common/os_calls.c:505:3:
/usr/include/i386-linux-gnu/bits/fcntl2/h:50:24: error: call to '__open_missing_mode' declared with attribute error: open with O_CREAT in second argument needs 3 arguments
	__open_missing_mode();
```
Solution: modify `os_calls.c:505` to return open(file_name, O_RDWR | O_CREAT, S_ORUSR | S_IWUSR). This problem is specific to earlier version of xrdp. libc API changed.

## How to trigger vulnerability

one terminal
```
./xrdp -nodaemon
```

another terminal
```
gcc -w poc.c -o poc -lssl -lX11 -lcrypto
./poc	localhost
```

## PoCs
[Exploit DB](https://www.exploit-db.com/exploits/8469/)

## Root Cause
```
rdp/rdp_rdp.c
rdp_rdp_process_color_pointer_pdu (struct rdp_rdp* self, struct stream* s) {
	// self is dynmatically allocated in heap
	int cache_idx;
	int dlen;
	int mlen;
	struct rdp_cursor* cursor;

	in_uint16_le(s, cache_idx);
	cursor = self->cursors+cache_idx;
	...
	in_uint16_le(s, mlen); // mlen is from input 
	in_uint16_le(s, dlen); // dlen is from input
	in_uint8a(s, cursor->data, dlen); // copy dlen bytes from s->p to cursor->data, heap overflow here
	in_uint8a(s, cursor->mask, mlen); // heap overflow here
}
```
```
Xserver/hw/rdp
#define in_uint16_le(s,v) \
{\
	(v) = (unsigned short) \
		( \
			(*((unsigned char*)((s)->p + 0)) << 0) | \ // p is a member variable of structure stream
			(*((unsigned char*)((s)->p + 1)) << 8) \
		); \
		(s)->p += 2; \
}
```
```
common/parse.h
#define in_uint8a(s, v, n) \
{\
	g_memcpy((v), (s)->p, (n)); \
	(s)->p += (n); \
}
```
## Vulnerability Patch

## References
