# CVE-2007-6731

## Experiment Environment

Ubuntu 8.10

## INSTALL & Configuration

```
wget https://github.com/mudongliang/source-packages/raw/master/CVE-2007-6731/xmp-2.5.1.tar.gz
tar -xvf xmp-2.5.1.tar.gz
cd xmp-2.5.1
./configure
make
```

## Problems in Installation & Configuration

## How to trigger vulnerability

```
gcc -o poc poc.c

./poc 1 poc.oxm
./poc 2 poc.dtt

./src/main/xmp poc.oxm
./src/main/xmp poc.dtt
```

## PoCs

[Extended Module Player (XMP) Vulnerability](http://aluigi.altervista.org/adv/xmpbof-adv.txt)

[Extended Module Player (xmp) 'oxm.c' And 'dtt_load.c' Multiple Local Buffer Overflow Vulnerabilities](https://www.securityfocus.com/bid/27047/exploit)

[Extended Module Player (xmp) 2.5.1 - 'oxm.c' / 'dtt_load.c' Multiple Local Buffer Overflow Vulnerabilities](https://www.exploit-db.com/exploits/30942/)

## Vulnerability Patch

### Root Cause

A] buffer-overflow in test_oxm / decrunch_oxm

The functions which handle the OXM file format (not active in Windows
and Amiga) are vulnerable to a buffer-overflow caused by the bypassing
of the "ilen > 263" check due to the sign of ilen.
So setting ilen to a negative value will allow an attacker to overflow
the buf buffer and possibly executing malicious code.

from misc/oxm.c:

```
int test_oxm(FILE *f)
{
    int i, j;
    int hlen, npat, len, plen;
    int nins, nsmp, ilen;
    int slen[256];
    uint8 buf[1024];
    ...
        ilen = read32l(f);
        if (ilen > 263)
            return -1;
        fseek(f, -4, SEEK_CUR);
        fread(buf, ilen, 1, f);     /* instrument header */
        ...
```

The same problem is located in decrunch_oxm() which naturally is not so
important in this case since test_oxm() is called before it.

B] buffer-overflow in dtt_load

Another vulnerability is located in dtt_load() where the pofs and plen
arrays can be overflowed with arbitrary data.

from loaders/dtt_load.c:

```
static int dtt_load(struct xmp_context *ctx, FILE *f, const int start)
    ...
    uint32 pofs[256];
    uint8 plen[256];
    int sdata[64];
    ...
    m->xxh->pat = read32l(f);
    ...
    for (i = 0; i < m->xxh->pat; i++)
        pofs[i] = read32l(f);
    ...
```

### Stack Trace

### Patch

## References
