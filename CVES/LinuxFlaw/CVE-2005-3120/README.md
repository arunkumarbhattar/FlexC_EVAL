# CVE-2005-3120

## Experiment Environment

Ubuntu 14.04.5

## INSTALL & Configuration

```
wget https://github.com/mudongliang/source-packages/raw/master/CVE-2005-3120/lynx-2.8.3.tar.gz
tar -xvf lynx-2.8.3.tar.gz
cd lynx-2.8.3.rel1
./configure
make
```

## Problems in Installation & Configuration


## How to trigger vulnerability

Server:

```
sudo perl 1256.pl
sudo perl 1288.pl
```

Client:

```
sudo ./lynx nntp://localhost/my.server
```

## PoCs

[Lynx 2.8.6dev.13 - Remote Buffer Overflow](https://www.exploit-db.com/exploits/1288/)

[Lynx 2.8.6dev.13 - Remote Buffer Overflow (PoC)](https://www.exploit-db.com/exploits/1256/)

[Lynx NNTP Article Header Buffer Overflow Vulnerability](https://www.securityfocus.com/bid/15117/exploit)

## Vulnerability Details & Patch

### Root Cause

I have found a remote buffer overflow in Lynx. It occurs when a Lynx 
user selects malicious links or simply visits malicious web pages! 
 
When Lynx connects to an NNTP server to fetch information about the 
available articles in a newsgroup, it will call a function called 
HTrjis() with the information from certain article headers. The 
function adds missing ESC characters to certain data, to support 
Asian character sets. However, it does not check if it writes outside 
of the char array buf, and that causes a remote stack-based buffer 
overflow, with full control over EIP, EBX, EBP, ESI and EDI.

The vulnerable code is in the `for` loop:

```
PUBLIC int HTrjis ARGS2(
        char *,         t,
        char *,         s)
{
    char *p, buf[LINE_LENGTH];
    int kanji = 0;

    if (strchr(s, ESC) || !strchr(s, '$')) {
        if (s != t)
            strcpy(t, s);
        return 1;
    }
    for (p = buf; *s; ) {
        if (!kanji && s[0] == '$' && (s[1] == '@' || s[1] == 'B')) {
            if (HTmaybekanji((int)s[2], (int)s[3])) {
                kanji = 1;
                *p++ = ESC;
                *p++ = *s++;
                *p++ = *s++;
                *p++ = *s++;
                *p++ = *s++;
                continue;
            }
            *p++ = *s++;
            continue;
        }
        if (kanji && s[0] == '(' && (s[1] == 'J' || s[1] == 'B')) {
            kanji = 0;
            *p++ = ESC;
            *p++ = *s++;
            *p++ = *s++;
            continue;
        }
        *p++ = *s++;
    }
    *p = *s;    /* terminate string */

    strcpy(t, buf);
    return 0;
}

```

### Stack Trace

### Patch

```
-int HTrjis(char *t,
+int HTrjis(char **t,
 	   char *s)
 {
-    char *p, buf[LINE_LENGTH];
+    char *p;
+    char *buf = NULL;
     int kanji = 0;
 
-    if (strchr(s, ESC) || !strchr(s, '$')) {
-	if (s != t)
-	    strcpy(t, s);
+    if (strchr(s, CH_ESC) || !strchr(s, '$')) {
+	if (s != *t)
+	    StrAllocCopy(*t, s);
 	return 1;
     }
+
+    if ((buf = malloc(strlen(s) * 2 + 1)) == 0)
+	outofmem(__FILE__, "HTrjis");
+
     for (p = buf; *s;) {
 	if (!kanji && s[0] == '$' && (s[1] == '@' || s[1] == 'B')) {
 	    if (HTmaybekanji((int) s[2], (int) s[3])) {
 		kanji = 1;
-		*p++ = ESC;
+		*p++ = CH_ESC;
 		*p++ = *s++;
 		*p++ = *s++;
 		*p++ = *s++;
@@ -2302,7 +2316,7 @@
 	}
 	if (kanji && s[0] == '(' && (s[1] == 'J' || s[1] == 'B')) {
 	    kanji = 0;
-	    *p++ = ESC;
+	    *p++ = CH_ESC;
 	    *p++ = *s++;
 	    *p++ = *s++;
 	    continue;
@@ -2311,7 +2325,8 @@
     }
     *p = *s;			/* terminate string */
 
-    strcpy(t, buf);
+    StrAllocCopy(*t, buf);
+    FREE(buf);
     return 0;
 }
```

## References

[Bug 108451 - www-client/lynx Remote Buffer Overflow (CAN-2005-3120)](https://bugs.gentoo.org/108451)

[Bug 170253 - (CVE-2005-3120) CAN-2005-3120 lynx buffer overflow](https://bugzilla.redhat.com/show_bug.cgi?id=170253)

[Proposed patch from Thomas Dickey for lynx 2.8.6dev.14](https://bugzilla.redhat.com/attachment.cgi?id=119760)
