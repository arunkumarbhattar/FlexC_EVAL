# CVE-2006-4144

## Experiment Environment

CentOS 6.5

## INSTALL & Configuration

```
wget https://github.com/mudongliang/source-packages/raw/master/CVE-2005-1275/ImageMagick-6.2.0-8.tar.gz
tar -xvf ImageMagick-6.2.0-8.tar.gz
cd ImageMagick-6.2.0
./configure
make
sudo make install
```

## Problems in Installation & Configuration

## How to trigger vulnerability

```
display imheap.sgi
```

## PoCs

[ImageMagick ReadSGIImage() Heap Overflow](https://www.securityfocus.com/archive/1/443208)

[ImageMagick SGI Image File Remote Heap Buffer Overflow Vulnerability](https://www.securityfocus.com/bid/19507/exploit)

[ImageMagick 6.x - '.SGI' Image File Remote Heap Buffer Overflow](https://www.exploit-db.com/exploits/28383/)

## Vulnerability Patch

### Root Cause

A heap overflow exists in ReadSGIImage() function, that is used to
decode a SGI image file. The vulnerable code is:

coders/sgi.c:

```
static Image *ReadSGIImage(const ImageInfo *image_info,ExceptionInfo *exception)
{
    ...
    iris_info.bytes_per_pixel=(unsigned char) ReadBlobByte(image);
    ...
    image->columns=iris_info.columns;
    image->rows=iris_info.rows;
    ...
    bytes_per_pixel=(size_t) iris_info.bytes_per_pixel;
    number_pixels=(MagickSizeType) iris_info.columns*iris_info.rows;
    ...
    iris_pixels=(unsigned char *)AcquireMagickMemory
(4*bytes_per_pixel*iris_info.columns*iris_info.rows);
```

We can manipalute iris_info.rows, iris_info.columns and bytes_per_pixel
value. Allocation of memory to "iris_pixels" is based on this values.
When rows*cols*bytes_per_pixe*4 overflow integer variable, we can alloc not enough memory for next operations, and cause heap overflow.

### Stack Trace

### Patch

## References
