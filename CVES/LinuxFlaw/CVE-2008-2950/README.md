# CVE-2008-2950

## Experiment Environment

Ubuntu 14.04 LTS

## INSTALL & Configuration

```
wget https://github.com/mudongliang/source-packages/raw/master/CVE-2008-2950/poppler-0.8.4.tar.gz
tar xvf poppler-0.8.4.tar.gz
cd poppler-0.8.4
mkdir build
./configure --prefix=`pwd`/build
make 
make install
```

## Problems in Installation & Configuration

```
pdftoabw.o: undefined reference to symbol 'xmlSaveFormatFileEnc@@LIBXML2_2.4.30'
```
Solution: CXXFLAGS="-lxml2" ./configure

```
error: 'FT_New_Size' was not declared in this scope

error: 'glyph' was not declared in this scope

```
This problem is specific to version 0.5.0 as far as we know

Solutions: 

comment #include FT

add			#include <ftsizes.h>

add			#include <ftglyph.h>

in splash/SplashFTFont.cc


## How to trigger vulnerability

```
python poc.py debian4-pdftotext > poc.pdf
build/bin/pdftotext poc.pdf
```

## PoCs
[exploit-db](https://www.exploit-db.com/exploits/6032/)

[Poppler PDF Rendering Library Page Class Remote Code Execution Vulnerability](https://www.securityfocus.com/bid/30107/exploit)

## Vulnerability Details & Patch

### Root Cause

Catalog.cc:250
```
Catalog::readPageTree(int start) { // parent function of buggy function
	Page* page;
	page = new Page(); // call constructor function of page
	if (!page->isOk()) {
		++start;
		goto err3;
	}
	...
	err3:
	delete page; // call destructor function of page
}
```
Page.cc:231
```
Page::Page() {
	// pageWidgets doesn't get initialized here
	lookupNF("Annots", &annots);
	if (!(annots.isRef() || annots.isArray() || annots.isNull())) {
		goto err2; // goto err2 directly without initializing pageWidgets
	}
	pageWidgets = new FormPageWidgets(); // pageWidgets get initialized here
	err2:
}
```
Page.cc:309
```
Page::~Page() {
	delete pageWidgets; // SIGSEGV here
}
```

### Stack Trace
```
0  FormPageWidgets::~FormPageWidgets (this=0x8100468, __in_chrg=<optimized out>) at Form.cc:1290
1  0xb7efe774 in Page::~Page (this=0x8059b50, __in_chrg=<optimized out>) at Page.cc:310
2  0xb7eacf64 in Catalog::readPageTree (this=this@entry=0x8058db0, 
    pagesDict=0x80597f0, attrs=attrs@entry=0x0, start=3, start@entry=0, 
    alreadyRead=alreadyRead@entry=0x8059590 "") at Catalog.cc:320
3  0xb7ead87c in Catalog::Catalog (this=0x8058db0, xrefA=0x8056c30) at Catalog.cc:99
4  0xb7f00f1d in PDFDoc::setup (this=this@entry=0x8056950, 
    ownerPassword=ownerPassword@entry=0x0, userPassword=userPassword@entry=0x0)
    at PDFDoc.cc:215
5  0xb7f010b8 in PDFDoc::PDFDoc (this=0x8056950, fileNameA=0x804d008, 
    ownerPassword=0x0, userPassword=0x0, guiDataA=0x0) at PDFDoc.cc:104
6  0x080492d5 in main (argc=2, argv=0xbffff2e4) at pdftotext.cc:152
```

### Patch 

```
diff --git a/poppler/Page.cc b/poppler/Page.cc
index b28a3ee..72a706b 100644
--- a/poppler/Page.cc
+++ b/poppler/Page.cc
@@ -230,7 +230,7 @@ GBool PageAttrs::readBox(Dict *dict, char *key, PDFRectangle *box) {
 
 Page::Page(XRef *xrefA, int numA, Dict *pageDict, PageAttrs *attrsA, Form *form) {
   Object tmp;
-	
+  pageWidgets =	NULL;  //Security fix
   ok = gTrue;
   xref = xrefA;
   num = numA;
```

## References

[oCERT-2008-007 libpoppler uninitialized pointer](http://ocert.org/advisories/ocert-2008-007.html)

[Poppler Memory Allocation Bug in 'Page.cc' Lets Remote Users Execute Arbitrary Code](https://www.securitytracker.com/id?1020435)
