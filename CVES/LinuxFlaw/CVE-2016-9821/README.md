# CVE-2016-9821

## Experiment Environment

Ubuntu 20.04

## INSTALL & Configuration

```
git clone https://github.com/libav/libav.git
cd libav
git checkout v11.8
./configure
make
```

## Problems in Installation & Configuration

```
yasm/nasm not found or too old. Use --disable-yasm for a crippled build.
```

Try to install or upgrade the `nasm`.
```
sudo apt install nasm
```

## How to trigger vulnerability
```
./libav/avprobe ./00037-libav-signedintoverflow-mpegvideo_parser
```

## PoCs

Inside the folder: 
[00037-libav-signedintoverflow-mpegvideo_parser](https://github.com/asarubbo/poc/blob/master/00037-libav-signedintoverflow-mpegvideo_parser)

## Vulnerability Details & Patch

### Root Cause

libavcodec/mpegvideo_parser.c:91:65: runtime error: signed integer overflow: 28573696 * 400 cannot be represented in type ‘int’

### Stack Trace

```
#0  ff_put_pixels16_sse2.loop () at libavcodec/x86/fpel.asm:74
#1  0x00005555558e2e0c in mpeg_motion_internal (mb_y=0, is_mpeg12=1, h=16, 
    motion_y=0, motion_x=0, pix_op=0x5555564976d0, ref_picture=<optimized out>, 
    field_select=0, bottom_field=0, field_based=0, dest_cr=0x7ffff758e040 "", 
    dest_cb=0x7ffff772c040 "", dest_y=0x7ffff78ca040 "", s=0x555556496dc0)
    at libavcodec/mpegvideo_motion.c:357
#2  mpeg_motion (s=0x555556496dc0, dest_y=0x7ffff78ca040 "", 
    dest_cb=0x7ffff772c040 "", dest_cr=0x7ffff758e040 "", field_select=0, 
    ref_picture=<optimized out>, pix_op=0x5555564976d0, motion_x=0, motion_y=0, 
    h=16, mb_y=0) at libavcodec/mpegvideo_motion.c:379
#3  0x00005555558e515c in mpv_motion_internal (is_mpeg12=<optimized out>, 
    qpix_op=<optimized out>, pix_op=<optimized out>, ref_picture=<optimized out>, 
    dir=<optimized out>, dest_cr=<optimized out>, dest_cb=<optimized out>, 
    dest_y=<optimized out>, s=<optimized out>) at libavcodec/mpegvideo_motion.c:906
#4  ff_mpv_motion (s=0x555556496dc0, dest_y=0x7ffff78ca040 "", 
    dest_cb=0x7ffff772c040 "", dest_cr=0x7ffff758e040 "", dir=<optimized out>, 
    ref_picture=<optimized out>, pix_op=0x5555564976d0, qpix_op=0x0)
    at libavcodec/mpegvideo_motion.c:977
#5  0x00005555558d286f in mpv_decode_mb_internal (is_mpeg12=1, 
    block=<optimized out>, s=0x555556496dc0) at libavcodec/mpegvideo.c:2223
#6  ff_mpv_decode_mb (s=0x555556496dc0, block=<optimized out>)
    at libavcodec/mpegvideo.c:2355
#7  0x000055555589e779 in mpeg_decode_slice (s=s@entry=0x555556496dc0, 
    mb_y=mb_y@entry=0, buf=buf@entry=0x7fffffffdb38, buf_size=buf_size@entry=50)
    at libavcodec/mpeg12dec.c:1857
#8  0x00005555558a1091 in decode_chunks (avctx=0x5555564961c0, 
    picture=0x55555649b280, got_output=0x7fffffffdcec, buf=0x555556486d20 "", 
    buf_size=430) at libavcodec/mpeg12dec.c:2583
#9  0x00005555558a215b in mpeg_decode_frame (avctx=0x5555564961c0, 
    data=0x55555649b280, got_output=0x7fffffffdcec, avpkt=<optimized out>)
    at libavcodec/mpeg12dec.c:2651
#10 0x00005555559b1c1c in avcodec_decode_video2 (avctx=0x5555564961c0, 
    picture=0x55555649b280, got_picture_ptr=got_picture_ptr@entry=0x7fffffffdcec, 
    avpkt=avpkt@entry=0x7fffffffdd00) at libavcodec/utils.c:1600
#11 0x00005555556a7523 in try_decode_frame (st=st@entry=0x555556495fa0, 
    avpkt=avpkt@entry=0x55555649b1c0, options=<optimized out>)
    at libavformat/utils.c:1910
#12 0x00005555556aa7c5 in avformat_find_stream_info (ic=0x555556495a60, options=0x0)
    at libavformat/utils.c:2276
#13 0x00005555555e1f33 in open_input_file (
    filename=0x7fffffffe564 "./00037-libav-signedintoverflow-mpegvideo_parser", 
    fmt_ctx_ptr=0x7fffffffe040) at avprobe.c:715
#14 probe_file (
    filename=0x7fffffffe564 "./00037-libav-signedintoverflow-mpegvideo_parser")
    at avprobe.c:763
#15 main (argc=2, argv=<optimized out>) at avprobe.c:961
```
## References
