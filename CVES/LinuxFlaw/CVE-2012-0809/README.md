# CVE-2012-0809

## Experiment Environment

Ubuntu 14.04LTS

## INSTALL & Configuration

```
wget https://github.com/mudongliang/source-packages/raw/master/CVE-2012-0809/sudo-1.8.0.tar.gz
tar -xvf sudo-1.8.0.tar.gz
cd sudo-1.8.0
./configure
make
```

## Problems in Installation & Configuration


## How to trigger vulnerability

```
cd src
ln -s ./sudo %n
sudo ./%n -D9
*** %n in writable segment detected ***
```

## PoCs

[Sudo format string vulnerability](https://www.sudo.ws/sudo/alerts/sudo_debug.html)

[](http://seclists.org/fulldisclosure/2012/Jan/att-590/advisory_sudo.txt)

## Vulnerability Details & Patch

### Root Cause

```
void
sudo_debug(int level, const char *fmt, ...)
{
    va_list ap;
    char *fmt2;

    if (level > debug_level)
        return;

    /* Backet fmt with program name and a newline to make it a single 
    write */
    easprintf(&fmt2, "%s: %s\n", getprogname(), fmt);
    va_start(ap, fmt);
    vfprintf(stderr, fmt2, ap);
    va_end(ap);
    efree(fmt2);
}
```

Here getprogname() is argv[0] and by this user controlled. So 
argv[0] goes to fmt2 which then gets vfprintf()ed to stderr. The
result is a Format String vulnerability.   

### Stack Trace

### Patch

```
diff -urNa sudo-1.8.3p1/src/sudo.c sudo-1.8.3p2/src/sudo.c
--- sudo-1.8.3p1/src/sudo.c	Fri Oct 21 09:01:26 2011
+++ sudo-1.8.3p2/src/sudo.c	Tue Jan 24 15:59:03 2012
@@ -1208,15 +1208,15 @@
 sudo_debug(int level, const char *fmt, ...)
 {
     va_list ap;
-    char *fmt2;
+    char *buf;
 
     if (level > debug_level)
 	return;
 
-    /* Backet fmt with program name and a newline to make it a single write */
-    easprintf(&fmt2, "%s: %s\n", getprogname(), fmt);
+    /* Bracket fmt with program name and a newline to make it a single write */
     va_start(ap, fmt);
-    vfprintf(stderr, fmt2, ap);
+    evasprintf(&buf, fmt, ap);
     va_end(ap);
-    efree(fmt2);
+    fprintf(stderr, "%s: %s\n", getprogname(), buf);
+    efree(buf);
 }
```

## References
