# CVE-2016-5636

## Experiment Environment

Ubuntu 14.04LTS

## INSTALL & Configuration

```
wget https://github.com/mudongliang/source-packages/raw/master/CVE-2016-5636/Python-2.7.6.tgz
tar -xvf Python-2.7.6.tgz
cd Python-2.7.6
./configure
make
```

## Problems in Installation & Configuration


## How to trigger vulnerability

```
python crash.py
```

## PoCs

[heap overflow in zipimporter module](https://bugs.python.org/issue26171)

[Python CVE-2016-5636 Heap Buffer Overflow Vulnerability](https://www.securityfocus.com/bid/91247/exploit)

## Vulnerability Details & Patch

### Root Cause

in zipimport.c

```
1116     bytes_size = compress == 0 ? data_size : data_size + 1;
1117     if (bytes_size == 0)
1118         bytes_size++;
1119     raw_data = PyBytes_FromStringAndSize((char *)NULL, bytes_size);
```

If compress != 0, then bytes_size = data_size + 1
data_size is not sanitized, so if data_size = -1, then it overflows and becomes 0.
In that case bytes_size becomes 1 and python allocates small heap, but after that in fread, it overflows heap.

### Stack Trace

### Patch

```
--- a/Modules/zipimport.c
+++ b/Modules/zipimport.c
@@ -1111,6 +1111,11 @@ get_data(PyObject *archive, PyObject *to
     }
     file_offset += l;           /* Start of file data */
 
+    if (data_size > LONG_MAX - 1) {
+        fclose(fp);
+        PyErr_NoMemory();
+        return NULL;
+    }
     bytes_size = compress == 0 ? data_size : data_size + 1;
     if (bytes_size == 0)
         bytes_size++;
```

## References
