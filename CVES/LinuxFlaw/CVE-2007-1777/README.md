# CVE-2007-1777

## Experiment Environment

CentOS 6.5

## INSTALL & Configuration

```
wget https://github.com/mudongliang/source-packages/raw/master/CVE-2007-1777/php-4.4.4.tar.gz
tar -xvf php-4.4.4.tar.gz
cd php-4.4.4
./configure
make
```

## Problems in Installation & Configuration

## How to trigger vulnerability

```
./sapi/cli/php poc.php
```

## PoCs

[MOPB-35-2007:PHP 4 zip_entry_read() Integer Overflow Vulnerability](http://www.php-security.org/MOPB/MOPB-35-2007.html)

[PHP Zip_Entry_Read() Integer Overflow Vulnerability](https://www.securityfocus.com/bid/23169/exploit)

[PHP 4.4.4 - 'Zip_Entry_Read()' Integer Overflow](https://www.exploit-db.com/exploits/29788/)

## Vulnerability Patch

### Root Cause

The `zip_entry_read()` function does not perform any check on the supplied length parameter. Therefore an integer overflow in memory allocation can happen when it adds one byte for a terminating ASCIIZ character.

```
    buf = emalloc(len + 1);
    ret = zzip_read(entry->fp, buf, len);
    buf[ret] = 0;
```

When a length of 0xffffffff is supplied the allocated memory block will be of size 0 while up to 4 GB of data is read from the ZIP archive into this memory block. This will overwrite everything behind the allocated block and can lead to the execution of arbitrary code.

### Stack Trace
#0  0x0000558059291e41 in _efree (ptr=0x558059beaf28) at /home/guo/Desktop/reproduction/CVE/CVE-2007-1777/php-4.4.4/Zend/zend_alloc.c:274
#1  0x0000558059297cec in _zval_ptr_dtor (zval_ptr=0x558059beb1d0) at /home/guo/Desktop/reproduction/CVE/CVE-2007-1777/php-4.4.4/Zend/zend_execute_API.c:289
#2  0x00005580592a7568 in zend_hash_destroy (ht=0x558059beb0a8) at /home/guo/Desktop/reproduction/CVE/CVE-2007-1777/php-4.4.4/Zend/zend_hash.c:558
#3  0x00005580592a0b69 in _zval_dtor (zvalue=0x558059beb298) at /home/guo/Desktop/reproduction/CVE/CVE-2007-1777/php-4.4.4/Zend/zend_variables.c:51
#4  0x0000558059297cec in _zval_ptr_dtor (zval_ptr=0x558059beb240) at /home/guo/Desktop/reproduction/CVE/CVE-2007-1777/php-4.4.4/Zend/zend_execute_API.c:289
#5  0x00005580592a7568 in zend_hash_destroy (ht=0x558059bd6808) at /home/guo/Desktop/reproduction/CVE/CVE-2007-1777/php-4.4.4/Zend/zend_hash.c:558
#6  0x00005580592a0b69 in _zval_dtor (zvalue=0x558059bd67c8) at /home/guo/Desktop/reproduction/CVE/CVE-2007-1777/php-4.4.4/Zend/zend_variables.c:51
#7  0x0000558059297cec in _zval_ptr_dtor (zval_ptr=0x558059bd6770) at /home/guo/Desktop/reproduction/CVE/CVE-2007-1777/php-4.4.4/Zend/zend_execute_API.c:289
#8  0x00005580592a7568 in zend_hash_destroy (ht=0x558059543c90 <executor_globals+400>) at /home/guo/Desktop/reproduction/CVE/CVE-2007-1777/php-4.4.4/Zend/zend_hash.c:558
#9  0x0000558059298914 in shutdown_executor () at /home/guo/Desktop/reproduction/CVE/CVE-2007-1777/php-4.4.4/Zend/zend_execute_API.c:184
#10 0x00005580592a1ccb in zend_deactivate () at /home/guo/Desktop/reproduction/CVE/CVE-2007-1777/php-4.4.4/Zend/zend.c:689
#11 0x00005580592742e6 in php_request_shutdown (dummy=<optimized out>) at /home/guo/Desktop/reproduction/CVE/CVE-2007-1777/php-4.4.4/main/main.c:999
#12 0x00005580591afa79 in main (argc=0x2, argv=0x7ffc9f809768) at /home/guo/Desktop/reproduction/CVE/CVE-2007-1777/php-4.4.4/sapi/cli/php_cli.c:883
### Patch

## References
