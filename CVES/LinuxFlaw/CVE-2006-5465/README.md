# CVE-2006-5465

## Experiment Environment

CentOS 6.5

## INSTALL & Configuration

```
wget https://github.com/mudongliang/source-packages/raw/master/CVE-2006-5465/php-4.4.4.tar.gz
tar -xvf php-4.4.4.tar.gz
cd php-4.4.4
./configure
make
```

## Problems in Installation & Configuration


## How to trigger vulnerability

```
./sapi/cli/php poc.php
```

## PoCs

[PHP 4.4.4/5.1.6 - 'htmlentities()' Local Buffer Overflow (PoC)](https://www.exploit-db.com/exploits/2857/)

[PHP HTMLEntities HTMLSpecialChars Buffer Overflow Vulnerabilities](https://www.securityfocus.com/bid/20879/exploit)

## Vulnerability Details & Patch

### Root Cause

> Buffer overflow in PHP before 5.2.0 allows remote attackers to execute arbitrary code 
> via crafted UTF-8 inputs to the (1) htmlentities or (2) htmlspecialchars functions.

### Stack Trace


### Patch

```
--- php-src/ext/standard/html.c:1.111.2.2.2.2	Mon Oct  2 07:58:13 2006
+++ php-src/ext/standard/html.c	Wed Nov  1 01:55:11 2006
@@ -18,7 +18,7 @@
    +----------------------------------------------------------------------+
 */
 
-/* $Id: html.c,v 1.111.2.2.2.2 2006/10/02 07:58:13 bjori Exp $ */
+/* $Id: html.c,v 1.111.2.2.2.3 2006/11/01 01:55:11 iliaa Exp $ */
 
 /*
  * HTML entity resources:
@@ -1105,7 +1105,7 @@
 
 		matches_map = 0;
 
-		if (len + 9 > maxlen)
+		if (len + 16 > maxlen)
 			replaced = erealloc (replaced, maxlen += 128);
 
 		if (all) {
@@ -1130,9 +1130,15 @@
 			}
 
 			if (matches_map) {
+				int l = strlen(rep);
+				/* increase the buffer size */
+				if (len + 2 + l >= maxlen) {
+					replaced = erealloc(replaced, maxlen += 128);
+				}
+
 				replaced[len++] = '&';
 				strcpy(replaced + len, rep);
-				len += strlen(rep);
+				len += l;
 				replaced[len++] = ';';
 			}
 		}
```

Details are in <http://news.php.net/php.cvs/41275>

## References
