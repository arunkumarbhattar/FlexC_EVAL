# CVE-2002-1496

## Experiment Environment

Ubuntu 14.04 LTS

## INSTALL & Configuration

Compile source code of nullhttpd
```
wget https://github.com/mudongliang/source-packages/raw/master/CVE-2002-1496/nullhttpd-0.5.0.tar.gz
tar xvf nullhttpd-0.5.0.tar.gz
cd nullhttpd-0.5.0/src
make
```

Modify the configuration file
```
cd ./httpd/etc/
mv httpd.cfg-sample httpd.cfg
# Modify the absolute path in the httpd.cfg according to your environment
```

Note: I attached my configuration file in current directory.

## Problems in Installation & Configuration

```
main.h:264:5: error: conflicting types for 'getsid'
```

**Solution:**

modify all `getsid`, no matter declaration or definition or use to `this_getsid` in the source code so that type conflict could be avoided. In old version glibc, getside isn't implemented, symbol binding conflicts when shifting to new version glibc.

```
server.c(.text+0xfe1): undefined reference to `pthread_detach'
```

**Solution:**

Position $(LDFLAGS) (which contains "-lpthread") at the end of the compilation command in the Makefile. It should look something like this:

```
httpd: $(OBJECTS)
        $(CC) $(CFLAGS) $(OBJECTS) -o ../httpd/bin/httpd $(LDFLAGS)
        @echo Make httpd is complete.
```

## How to trigger vulnerability

In one terminal,

```
gcc -o nullhttpd nullhttpd.c
./nullhttpd -h localhost -t 2 -p 80
```

in another terminal,

```
cd ./http/bin
sudo ./httpd
```

If you want to see the moment of crash, you may need gdb.

```
sudo ./http --nodaemon
```

## PoCs

[Null HTTPd 0.5 - Remote Heap Overflow](https://www.exploit-db.com/exploits/21818/)

## Back trace
```
#0  0xb7fdccf9 in ?? ()
#1  0xb7e684ca in malloc_printerr (action=<optimized out>, 
    str=0xb7f5d2f8 "free(): invalid next size (normal)", ptr=0xb7c136c0)
    at malloc.c:4998
#2  0xb7e691bd in _int_free (av=0xb7c00010, p=<optimized out>, have_lock=0)
    at malloc.c:3842
#3  0xb7ea8a72 in __closedir (dirp=0xb7c136c0)
    at ../sysdeps/posix/closedir.c:50
#4  0x0804b50c in ?? ()
#5  0x0804ccd7 in ?? ()
#6  0x0804de42 in ?? ()
#7  0xb7facf72 in start_thread (arg=0xb7fd6b40) at pthread_create.c:312
#8  0xb7ee33ee in clone () at ../sysdeps/unix/sysv/linux/i386/clone.S:129
```

## Root Cause
http.c
```
read_header() {
	if (conn[sid].dat->in_ContentLength<MAX_POSISIZE) { // no check if in_ContentLength is negative
		ReadPOSTData(sid);
	}
}
```

http.c
```
ReadPOSTData() {
	conn[sid].PostData = calloc(conn[sid].dat->in_ContentLength+1024, sizeof(char));
	// dynamically allocate a memory region to conn[sid].PostData, however, conn[sid].dat->in_ContentLength could be negative
	char* pPostData = conn[sid].PostData;
	recv(conn[sid].socket, pPostData, 1024, 0); // heap overflow here
}
```
```
dirlist ()

closedir () // free here
```

## Vulnerability Patch

## References
