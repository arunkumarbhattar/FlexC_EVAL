# CVE-2010-2891

## Experiment Environment

Ubuntu 14.04 LTS

## INSTALL & Configuration

```
wget https://github.com/mudongliang/source-packages/raw/master/CVE-2010-2891/libsmi-0.4.8.tar.gz

tar -xvf libsmi-0.4.8.tar.gz
cd libsmi-0.4.8

./configure
make
sudo make install
```

## Problems in Installation & Configuration
```
./smisubtree `python 44276.py`
libsmi.so.2: cannot open shared object file
```
Solution: `sudo ldconfig`

```
/lib/smi.h:108:35: error: label at end of compound statement
#define SMI_MODEKIND_SCALAR	0x0002
smidiff.c:1742:11: note: in expansion of macro 'SMI_MODEKIND_SCALAR'
	case SMI_MODEKIND_SCALAR:
```

**Solution:**

```
add ; empty statement to smidiff.c:1742
```

## How to trigger vulnerability

```
gcc -o smisubtree smisubtree.c -lsmi
./smisubtree `python 44276.py`
```

## PoCs

[LibSMI smiGetNode - Buffer Overflow](https://www.exploit-db.com/exploits/15293/)

[smisubtree.c](https://www.ibr.cs.tu-bs.de/projects/libsmi/example.html?lang=de)

**Note: you can get smisubtree.c from `man libsmi`**

## Vulnerability Details & Patch

### Root Cause

```
lib/smi.c:1319

            oid[oidlen] = strtoul(p, NULL, 0);
```

### Stack Trace

```
(gdb) info stack
#0  __libc_free (mem=0x1) at malloc.c:3709
#1  0x0044f441 in smiFree (ptr=0x1) at util.c:133
#2  0x004512ef in smiGetNode (smiModulePtr=0x1, node=0x1 <Address 0x1 out of bounds>) at smi.c:1338
#3  0x00000001 in ?? ()
#4  0x00000001 in ?? ()
```

### Patch

```
Index: lib/smi.c
===================================================================
--- lib/smi.c   (revision 29144)
+++ lib/smi.c   (working copy)
@@ -1793,10 +1793,15 @@
     }
  
     if (isdigit((int)node2[0])) {
-   for (oidlen = 0, p = strtok(node2, ". "); p;
+   for (oidlen = 0, p = strtok(node2, ". ");
+        p && oidlen < sizeof(oid)/sizeof(oid[0]);
         oidlen++, p = strtok(NULL, ". ")) {
        oid[oidlen] = strtoul(p, NULL, 0);
    }
+   if (p) {
+       /* the numeric OID is too long */
+       return NULL;
+   }
    nodePtr = getNode(oidlen, oid);
    if (nodePtr) {
        if (modulePtr) {
```

## References

[1] [LibSMI smiGetNode Buffer Overflow](https://www.coresecurity.com/content/libsmi-smigetnode-buffer-overflow)
