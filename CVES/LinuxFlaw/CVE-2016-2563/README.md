# CVE-2016-2563

## Experiment Environment

Ubuntu 14.04 LTS

## INSTALL & Configuration

```
wget https://github.com/mudongliang/source-packages/raw/master/CVE-2016-2563/putty-0.66.tar.gz

tar -xvf putty-0.66.tar.gz
cd putty-0.66

./configure
make
```

## Problems in Installation & Configuration

```
sudo python poc.py
ERROR:root:No module named paramiko
```

**Solution:**

```
sudo pip install paramiko
```

```
error in cryptography setup command: Invalid environment marker: python_version < '3'
```

**Solution:**

`sudo pip install --upgrade pip setuptools`

```
sudo python poc.py
File "poc.py", line 18
	except ImportError, ie:
```

**Solution:**

change to `except ImportError as ie:`


## How to trigger vulnerability

```
sudo python poc.py

./pscp -P 23 -scp root@localhost:/etc/password .
```

## PoCs

[EDB-39551](https://www.exploit-db.com/exploits/39551/)

[cve-2016-2563](https://github.com/tintinweb/pub/tree/master/pocs/cve-2016-2563)

## Vulnerability Patch

### Root Cause

```
pscp.c:1503

		if (sscanf(act->buf, "%lo %s %n", &act->permissions,
										sizestr, &i) !=2)
```

### Stack Trace

```
(gdb) info stack
#0  0x0805769a in scp_get_sink_action (act=0x41414141) at pscp.c:1534
#1  0x41414141 in ?? ()
#2  0x41414141 in ?? ()
#3  0x41414141 in ?? ()
```

### Patch

```
diff --git a/pscp.c b/pscp.c
index a4e55fe..809c20f 100644
--- a/pscp.c
+++ b/pscp.c
@@ -1495,7 +1495,7 @@ int scp_get_sink_action(struct scp_sink_action *act)
        {
            char sizestr[40];

-           if (sscanf(act->buf, "%lo %s %n", &act->permissions,
+           if (sscanf(act->buf, "%lo %39s %n", &act->permissions,
                        sizestr, &i) != 2)
                bump("Protocol error: Illegal file descriptor format");
            act->size = uint64_from_decimal(sizestr);
```

## References

[1] [Putty Official Website](http://www.chiark.greenend.org.uk/~sgtatham/putty/)
