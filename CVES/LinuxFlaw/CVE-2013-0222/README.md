# CVE-2013-0222

## Experiment Environment

CentOS 6.4

## INSTALL & Configuration

```
wget https://github.com/mudongliang/source-packages/raw/master/CVE-2013-0222/coreutils-8.4-patched.tar.gz

tar -xvf coreutils-8.4-patched.tar.gz
cd coreutils-8.4
./configure
make
```

## Problems in Installation & Configuration

```
./stdio.h:177:1: error: 'gets' undeclared here (not in a function); did you mean 'fgets'?
  177 | /* It is very rare that the developer ever has full control of stdin,
      | ^~~~~~~~~~~~~~~
```

Removing lib/stdio.h:177 could work.

```
freadseek.c: In function 'freadptrinc':
freadseek.c:60:3: error: #error "Please port gnulib freadseek.c to your platform! Look at the definition of getc, getc_unlocked on your system, then report this to bug-gnulib."
   60 |  #error "Please port gnulib freadseek.c to your platform! Look at the definition of getc, getc_unlocked on your system, then report this to bug-gnulib."
      |   ^~~~~
```

Some similar compiler complaints also occur for the same reason that macro _IO_ftrylockfile is not accessible in glic of higher version.

A simple patch which fixes the two problems above: [fix-some-compile-issue-in-ubuntu20.patch](fix-some-compile-issue-in-ubuntu20.patch)

Before running `./configure`, apply the patch by:
```
# In coreutils-8.4/
patch -p1 < ../fix-some-compile-issue-in-ubuntu20.patch
```

Then run `./configure` and `make`.

This patch works well on both amd64 and aarch64 Ubuntu 20.04.

Note that build type should be specific on aarch64 platform since config.guess could not guess it.  
So run `./configure --build=aarch64-unknown-linux-gnu` instead.

See also:
 - [adjust to glibc 2.28 libio.h removal](https://lists.gnu.org/r/bug-gnulib/2018-03/txtTc1bTw2mGz.txt)
 - [gets undeclared here](https://mudongliang.github.io/2017/07/02/gets-undeclared-here.html)

## How to trigger vulnerability

```
perl -e 'print "1","\0"x50000000,"\r\n\r\n"' | uniq
```

## PoCs

[CVE-2013-0222: coreutils: segmentation fault in "uniq" with long line input](https://bugzilla.novell.com/show_bug.cgi?id=796243)

## Vulnerability Details & Patch

### Root Cause

```
uniq.c:392

	copy[i] = alloca (len[i] + 1);
```

### Stack Trace

```
(gdb) info stack
#0  0x08049ae8 in different_multi (old=<value optimized out>, new=<value optimized out>, oldlen=50000002, 
    newlen=50000002, oldstate=..., newstate=...) at uniq.c:397
#1  0x0804a8d3 in check_file (argc=1, argv=0xbf8f44d4) at uniq.c:513
#2  main (argc=1, argv=0xbf8f44d4) at uniq.c:806
```

## References
